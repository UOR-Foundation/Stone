<!-- Other external dependencies -->
<script crossorigin src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Framework Research Dashboard</title>
    <!-- External Dependencies -->
    <!-- React and its dependencies -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone@7.22.10/babel.min.js"></script>
    <!-- Other libraries -->
    <script crossorigin src="https://unpkg.com/axios@1.4.0/dist/axios.min.js"></script>
    <script crossorigin src="https://unpkg.com/crypto-js@4.1.1/crypto-js.js"></script>
    <!-- Load Monaco editor last to avoid conflicts -->
    <script src="https://unpkg.com/monaco-editor@0.40.0/min/vs/loader.js"></script>
    <script>
        // Define a global variable to hold Chart.js when it loads
        window.ChartLib = null;
    </script>
    <!-- Load Chart.js with a custom callback to avoid AMD conflicts -->
    <script>
        (function() {
            var script = document.createElement('script');
            script.onload = function() {
                // Store Chart globally but don't let it register as an AMD module
                window.ChartLib = window.Chart;
                window.Chart = undefined;
            };
            script.src = "https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js";
            document.head.appendChild(script);
        })();
    </script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .monaco-editor {
            width: 100%;
            height: 400px;
        }
        .dashboard-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            overflow: hidden;
        }
        .sidebar {
            background-color: #f3f4f6;
            padding: 1rem;
            overflow-y: auto;
        }
        .content-area {
            padding: 1rem;
            overflow-y: auto;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .process-step {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .current-step {
            background-color: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        .completed-step {
            background-color: #d1fae5;
            border-left: 3px solid #10b981;
        }
        .future-step {
            background-color: #f3f4f6;
            border-left: 3px solid #9ca3af;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div>
                <h2>Loading Prime Framework Dashboard...</h2>
                <p>If this message persists, please check the console for errors.</p>
            </div>
        </div>
    </div>
    
    <script type="text/babel">
        // Type definitions
        /**
         * @typedef {Object} Project
         * @property {string} id
         * @property {string} name
         * @property {string} description
         * @property {Date} createdAt
         * @property {Date} updatedAt
         * @property {number} currentStage - 1-5
         * @property {Object} deliverables
         * @property {Deliverable} [deliverables.caseStudy]
         * @property {Deliverable} [deliverables.useCase]
         * @property {Deliverable} [deliverables.specification]
         * @property {Deliverable} [deliverables.implementation]
         * @property {Deliverable} [deliverables.verification]
         * @property {ContextFile[]} contextFiles
         */

        /**
         * @typedef {Object} Deliverable
         * @property {string} id
         * @property {string} title
         * @property {string} content
         * @property {'markdown' | 'code' | 'json' | 'text'} format
         * @property {Date} createdAt
         * @property {Date} updatedAt
         * @property {'draft' | 'completed'} status
         * @property {boolean} aiAssisted
         * @property {MessageExchange[]} [aiPromptHistory]
         */

        /**
         * @typedef {Object} ContextFile
         * @property {string} id
         * @property {string} filename
         * @property {string} content
         * @property {'coq' | 'markdown' | 'json' | 'other'} fileType
         * @property {boolean} processed
         * @property {any} [processingMetadata]
         * @property {'not_started' | 'processing' | 'completed' | 'failed'} embeddingStatus
         */

        /**
         * @typedef {Object} MessageExchange
         * @property {string} id
         * @property {Date} timestamp
         * @property {string} prompt
         * @property {string} response
         * @property {string} modelVersion
         * @property {number} temperature
         * @property {number} maxTokens
         * @property {string[]} [contextIds]
         */

        /**
         * @typedef {Object} AuthConfig
         * @property {string} [claudeApiKey]
         * @property {Object.<string, {apiKey?: string, endpoint?: string, status: 'connected' | 'disconnected' | 'error'}>} [otherServices]
         */

        // Utility Functions
        const generateId = () => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        
        const getFormattedDate = (date) => {
            return new Date(date).toLocaleDateString() + ' ' + new Date(date).toLocaleTimeString();
        };

        const encryptData = (data, key) => {
            return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        };

        const decryptData = (ciphertext, key) => {
            const bytes = CryptoJS.AES.decrypt(ciphertext, key);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        };

        const debounce = (func, delay) => {
            let debounceTimer;
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // React Context Definitions
        const ProjectContext = React.createContext();
        const AuthContext = React.createContext();
        const UIContext = React.createContext();
        const RAGContext = React.createContext();

        // Hook for local storage
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = React.useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        }

        // Context Providers
        function ProjectProvider({ children }) {
            const [projects, setProjects] = useLocalStorage('prime-framework-projects', []);
            const [currentProject, setCurrentProject] = React.useState(null);

            const createProject = (name, description) => {
                const newProject = {
                    id: generateId(),
                    name,
                    description,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    currentStage: 1,
                    deliverables: {},
                    contextFiles: []
                };
                
                setProjects([...projects, newProject]);
                setCurrentProject(newProject);
                return newProject;
            };

            const updateProject = (updatedProject) => {
                const updatedProjects = projects.map(project => 
                    project.id === updatedProject.id 
                        ? { ...updatedProject, updatedAt: new Date() } 
                        : project
                );
                setProjects(updatedProjects);
                if (currentProject && currentProject.id === updatedProject.id) {
                    setCurrentProject({ ...updatedProject, updatedAt: new Date() });
                }
            };

            const deleteProject = (projectId) => {
                setProjects(projects.filter(project => project.id !== projectId));
                if (currentProject && currentProject.id === projectId) {
                    setCurrentProject(null);
                }
            };

            const saveDeliverable = (projectId, stage, deliverable) => {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const stageMap = {
                    1: 'caseStudy',
                    2: 'useCase',
                    3: 'specification',
                    4: 'implementation',
                    5: 'verification'
                };

                const stageKey = stageMap[stage];
                const updatedDeliverables = { ...project.deliverables };
                updatedDeliverables[stageKey] = {
                    ...deliverable,
                    updatedAt: new Date()
                };

                const updatedProject = {
                    ...project,
                    deliverables: updatedDeliverables,
                    updatedAt: new Date()
                };

                updateProject(updatedProject);
            };

            const completeStage = (projectId, stage) => {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const stageMap = {
                    1: 'caseStudy',
                    2: 'useCase',
                    3: 'specification',
                    4: 'implementation',
                    5: 'verification'
                };

                const stageKey = stageMap[stage];
                if (!project.deliverables[stageKey]) return;

                const updatedDeliverables = { ...project.deliverables };
                updatedDeliverables[stageKey] = {
                    ...updatedDeliverables[stageKey],
                    status: 'completed'
                };

                const updatedProject = {
                    ...project,
                    deliverables: updatedDeliverables,
                    currentStage: Math.min(5, stage + 1),
                    updatedAt: new Date()
                };

                updateProject(updatedProject);
            };

            const addContextFile = (projectId, contextFile) => {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const updatedFiles = [...project.contextFiles, {
                    ...contextFile,
                    id: generateId()
                }];

                const updatedProject = {
                    ...project,
                    contextFiles: updatedFiles,
                    updatedAt: new Date()
                };

                updateProject(updatedProject);
            };

            const updateContextFile = (projectId, updatedFile) => {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const updatedFiles = project.contextFiles.map(file => 
                    file.id === updatedFile.id ? updatedFile : file
                );

                const updatedProject = {
                    ...project,
                    contextFiles: updatedFiles,
                    updatedAt: new Date()
                };

                updateProject(updatedProject);
            };

            const deleteContextFile = (projectId, fileId) => {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const updatedFiles = project.contextFiles.filter(file => file.id !== fileId);

                const updatedProject = {
                    ...project,
                    contextFiles: updatedFiles,
                    updatedAt: new Date()
                };

                updateProject(updatedProject);
            };

            return (
                <ProjectContext.Provider 
                    value={{ 
                        projects, 
                        currentProject, 
                        setCurrentProject, 
                        createProject, 
                        updateProject, 
                        deleteProject,
                        saveDeliverable,
                        completeStage,
                        addContextFile,
                        updateContextFile,
                        deleteContextFile
                    }}
                >
                    {children}
                </ProjectContext.Provider>
            );
        }

        function AuthProvider({ children }) {
            const [authConfig, setAuthConfig] = useLocalStorage('prime-framework-auth', {
                claudeApiKey: '',
                otherServices: {}
            });

            const [authStatus, setAuthStatus] = React.useState({
                claude: 'disconnected'
            });

            const updateClaudeApiKey = (apiKey) => {
                setAuthConfig({
                    ...authConfig,
                    claudeApiKey: apiKey
                });
            };

            const testClaudeConnection = async () => {
                if (!authConfig.claudeApiKey) {
                    setAuthStatus({
                        ...authStatus,
                        claude: 'disconnected'
                    });
                    return false;
                }
                
                setAuthStatus({
                    ...authStatus,
                    claude: 'connecting'
                });
                
                // Simulated connection test
                try {
                    // In a real app, you would make an actual API call to test the connection
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    setAuthStatus({
                        ...authStatus,
                        claude: 'connected'
                    });
                    return true;
                } catch (error) {
                    console.error('Claude connection test failed:', error);
                    setAuthStatus({
                        ...authStatus,
                        claude: 'error'
                    });
                    return false;
                }
            };

            const updateService = (serviceName, config) => {
                setAuthConfig({
                    ...authConfig,
                    otherServices: {
                        ...authConfig.otherServices,
                        [serviceName]: config
                    }
                });
            };

            React.useEffect(() => {
                if (authConfig.claudeApiKey) {
                    testClaudeConnection();
                }
            }, [authConfig.claudeApiKey]);

            return (
                <AuthContext.Provider 
                    value={{ 
                        authConfig, 
                        authStatus, 
                        updateClaudeApiKey, 
                        testClaudeConnection,
                        updateService
                    }}
                >
                    {children}
                </AuthContext.Provider>
            );
        }

        function UIProvider({ children }) {
            const [activeTab, setActiveTab] = React.useState('projects');
            const [currentStage, setCurrentStage] = React.useState(1);
            const [sidebarOpen, setSidebarOpen] = React.useState(true);
            const [notifications, setNotifications] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [modalContent, setModalContent] = React.useState(null);

            const addNotification = (message, type = 'info') => {
                const id = generateId();
                setNotifications([
                    ...notifications,
                    { id, message, type, timestamp: new Date() }
                ]);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    setNotifications(notifications => 
                        notifications.filter(n => n.id !== id)
                    );
                }, 5000);
            };

            const removeNotification = (id) => {
                setNotifications(notifications.filter(n => n.id !== id));
            };

            const openModal = (content) => {
                setModalContent(content);
            };

            const closeModal = () => {
                setModalContent(null);
            };

            return (
                <UIContext.Provider 
                    value={{ 
                        activeTab, 
                        setActiveTab, 
                        currentStage, 
                        setCurrentStage, 
                        sidebarOpen, 
                        setSidebarOpen,
                        notifications,
                        addNotification,
                        removeNotification,
                        isLoading,
                        setIsLoading,
                        modalContent,
                        openModal,
                        closeModal
                    }}
                >
                    {children}
                </UIContext.Provider>
            );
        }

        function RAGProvider({ children }) {
            const { currentProject } = React.useContext(ProjectContext);
            const [contextEmbeddings, setContextEmbeddings] = React.useState({});
            const [processingQueue, setProcessingQueue] = React.useState([]);
            const [relevantContexts, setRelevantContexts] = React.useState([]);

            const processContextFile = async (fileId) => {
                if (!currentProject) return;
                
                // Find the file in the current project
                const file = currentProject.contextFiles.find(f => f.id === fileId);
                if (!file) return;
                
                // Simulated processing - in a real implementation, you would:
                // 1. Parse the Coq file
                // 2. Extract meaningful chunks
                // 3. Generate embeddings for each chunk
                // 4. Store the embeddings
                
                // Update processing status
                setProcessingQueue([...processingQueue, fileId]);
                
                try {
                    // Simulate processing time
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Simulated embeddings (in a real app, these would be vectors)
                    const simulatedEmbeddings = {
                        fileId,
                        chunks: [
                            { id: generateId(), text: file.content.substring(0, 200), embedding: [0.1, 0.2, 0.3] },
                            { id: generateId(), text: file.content.substring(200, 400), embedding: [0.4, 0.5, 0.6] }
                        ]
                    };
                    
                    setContextEmbeddings({
                        ...contextEmbeddings,
                        [fileId]: simulatedEmbeddings
                    });
                    
                    // Remove from processing queue
                    setProcessingQueue(processingQueue.filter(id => id !== fileId));
                    
                    return true;
                } catch (error) {
                    console.error('Error processing context file:', error);
                    setProcessingQueue(processingQueue.filter(id => id !== fileId));
                    return false;
                }
            };

            const getRelevantContext = async (query) => {
                if (!currentProject || !query) return [];
                
                // Simulated context retrieval - in a real implementation, you would:
                // 1. Generate an embedding for the query
                // 2. Find the closest matches in your embeddings
                // 3. Return the relevant context chunks
                
                // For demo purposes, we'll return random context chunks
                const relevantFiles = currentProject.contextFiles.filter(
                    file => file.processed && contextEmbeddings[file.id]
                );
                
                if (relevantFiles.length === 0) return [];
                
                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Pick random chunks for the demo
                const randomChunks = [];
                relevantFiles.forEach(file => {
                    if (contextEmbeddings[file.id] && contextEmbeddings[file.id].chunks.length > 0) {
                        const randomChunk = contextEmbeddings[file.id].chunks[
                            Math.floor(Math.random() * contextEmbeddings[file.id].chunks.length)
                        ];
                        randomChunks.push({
                            fileId: file.id,
                            filename: file.filename,
                            chunk: randomChunk
                        });
                    }
                });
                
                setRelevantContexts(randomChunks);
                return randomChunks;
            };

            return (
                <RAGContext.Provider 
                    value={{ 
                        contextEmbeddings, 
                        processingQueue, 
                        relevantContexts,
                        processContextFile,
                        getRelevantContext
                    }}
                >
                    {children}
                </RAGContext.Provider>
            );
        }

        // Components
        function App() {
            return (
                <ProjectProvider>
                    <AuthProvider>
                        <UIProvider>
                            <RAGProvider>
                                <Dashboard />
                            </RAGProvider>
                        </UIProvider>
                    </AuthProvider>
                </ProjectProvider>
            );
        }

        function Dashboard() {
            const { activeTab } = React.useContext(UIContext);
            const { currentProject } = React.useContext(ProjectContext);
            
            return (
                <div className="dashboard-container">
                    <Header />
                    <div className="main-content">
                        <Sidebar />
                        <div className="content-area">
                            {!currentProject && activeTab === 'projects' && <ProjectsList />}
                            {currentProject && activeTab === 'projects' && <ProjectDetail />}
                            {activeTab === 'settings' && <SettingsPanel />}
                            {activeTab === 'context' && <ContextManager />}
                            {activeTab === 'stage' && <StagePanel />}
                        </div>
                    </div>
                    <Footer />
                    <NotificationArea />
                    <ModalContainer />
                </div>
            );
        }

        function Header() {
            const { currentProject } = React.useContext(ProjectContext);
            const { activeTab, setActiveTab } = React.useContext(UIContext);
            
            return (
                <header className="bg-gray-800 text-white p-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-xl font-bold">Prime Framework Research Dashboard</h1>
                            {currentProject && (
                                <span className="px-2 py-1 bg-blue-600 rounded text-sm">
                                    {currentProject.name}
                                </span>
                            )}
                        </div>
                        <nav>
                            <ul className="flex space-x-4">
                                <li>
                                    <button 
                                        className={`px-3 py-2 ${activeTab === 'projects' ? 'tab-active' : ''}`}
                                        onClick={() => setActiveTab('projects')}
                                    >
                                        Projects
                                    </button>
                                </li>
                                {currentProject && (
                                    <>
                                        <li>
                                            <button 
                                                className={`px-3 py-2 ${activeTab === 'stage' ? 'tab-active' : ''}`}
                                                onClick={() => setActiveTab('stage')}
                                            >
                                                Process Stage
                                            </button>
                                        </li>
                                        <li>
                                            <button 
                                                className={`px-3 py-2 ${activeTab === 'context' ? 'tab-active' : ''}`}
                                                onClick={() => setActiveTab('context')}
                                            >
                                                Context Manager
                                            </button>
                                        </li>
                                    </>
                                )}
                                <li>
                                    <button 
                                        className={`px-3 py-2 ${activeTab === 'settings' ? 'tab-active' : ''}`}
                                        onClick={() => setActiveTab('settings')}
                                    >
                                        Settings
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </header>
            );
        }

        function Sidebar() {
            const { currentProject } = React.useContext(ProjectContext);
            const { currentStage, setCurrentStage, setActiveTab } = React.useContext(UIContext);
            
            const stageInfo = [
                { number: 1, name: "Case Study", description: "Define the research domain and questions" },
                { number: 2, name: "Use Case", description: "Specify application areas and benefits" },
                { number: 3, name: "Specification", description: "Develop technical requirements" },
                { number: 4, name: "Implementation", description: "Create the implementation with AI assistance" },
                { number: 5, name: "Verification", description: "Verify implementation against requirements" }
            ];
            
            const handleStageClick = (stageNum) => {
                if (!currentProject) return;
                
                // Only allow navigating to completed stages or the current stage
                if (stageNum <= currentProject.currentStage) {
                    setCurrentStage(stageNum);
                    setActiveTab('stage');
                }
            };
            
            const getStageClassName = (stageNum) => {
                if (!currentProject) return "process-step future-step";
                
                if (stageNum < currentProject.currentStage) {
                    return "process-step completed-step";
                } else if (stageNum === currentProject.currentStage) {
                    return "process-step current-step";
                } else {
                    return "process-step future-step";
                }
            };
            
            return (
                <div className="sidebar">
                    <h2 className="text-lg font-semibold mb-4">Process Stages</h2>
                    {stageInfo.map(stage => (
                        <div 
                            key={stage.number}
                            className={getStageClassName(stage.number)}
                            onClick={() => handleStageClick(stage.number)}
                        >
                            <div className="flex items-center">
                                <div className="w-6 h-6 flex items-center justify-center bg-gray-200 rounded-full mr-2">
                                    {stage.number}
                                </div>
                                <span className="font-medium">{stage.name}</span>
                            </div>
                            <p className="text-sm text-gray-600 mt-1">{stage.description}</p>
                        </div>
                    ))}
                    
                    {currentProject && (
                        <div className="mt-8">
                            <h3 className="text-md font-semibold mb-2">Project Info</h3>
                            <div className="bg-white p-3 rounded shadow-sm">
                                <p className="text-sm">
                                    <span className="font-medium">Created:</span> {getFormattedDate(currentProject.createdAt)}
                                </p>
                                <p className="text-sm">
                                    <span className="font-medium">Updated:</span> {getFormattedDate(currentProject.updatedAt)}
                                </p>
                                <p className="text-sm">
                                    <span className="font-medium">Context Files:</span> {currentProject.contextFiles.length}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ProjectsList() {
            const { projects, createProject, setCurrentProject, deleteProject } = React.useContext(ProjectContext);
            const { addNotification, openModal } = React.useContext(UIContext);
            const [newProjectName, setNewProjectName] = React.useState("");
            const [newProjectDescription, setNewProjectDescription] = React.useState("");
            
            const handleCreateProject = () => {
                if (!newProjectName.trim()) {
                    addNotification("Project name is required", "error");
                    return;
                }
                
                const project = createProject(newProjectName, newProjectDescription);
                addNotification(`Project "${newProjectName}" created successfully`, "success");
                setNewProjectName("");
                setNewProjectDescription("");
            };
            
            const handleDeleteProject = (projectId, projectName) => {
                openModal(
                    <div className="p-4">
                        <h3 className="text-lg font-semibold mb-4">Confirm Deletion</h3>
                        <p className="mb-4">Are you sure you want to delete project "{projectName}"? This action cannot be undone.</p>
                        <div className="flex justify-end space-x-2">
                            <button 
                                className="px-4 py-2 bg-gray-200 rounded"
                                onClick={() => openModal(null)}
                            >
                                Cancel
                            </button>
                            <button 
                                className="px-4 py-2 bg-red-600 text-white rounded"
                                onClick={() => {
                                    deleteProject(projectId);
                                    openModal(null);
                                    addNotification(`Project "${projectName}" deleted`, "info");
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                );
            };
            
            return (
                <div>
                    <h2 className="text-xl font-semibold mb-4">Projects</h2>
                    
                    {/* Create New Project Form */}
                    <div className="bg-white p-4 rounded shadow-sm mb-6">
                        <h3 className="text-lg font-medium mb-3">Create New Project</h3>
                        <div className="mb-3">
                            <label className="block text-sm font-medium mb-1">Project Name</label>
                            <input 
                                type="text" 
                                className="w-full p-2 border rounded"
                                value={newProjectName}
                                onChange={(e) => setNewProjectName(e.target.value)}
                                placeholder="Enter project name"
                            />
                        </div>
                        <div className="mb-3">
                            <label className="block text-sm font-medium mb-1">Description</label>
                            <textarea 
                                className="w-full p-2 border rounded"
                                value={newProjectDescription}
                                onChange={(e) => setNewProjectDescription(e.target.value)}
                                placeholder="Enter project description"
                                rows="3"
                            ></textarea>
                        </div>
                        <button 
                            className="px-4 py-2 bg-blue-600 text-white rounded"
                            onClick={handleCreateProject}
                        >
                            Create Project
                        </button>
                    </div>
                    
                    {/* Projects List */}
                    {projects.length === 0 ? (
                        <div className="bg-gray-50 p-6 rounded text-center">
                            <p className="text-gray-500">No projects found. Create your first project to get started.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {projects.map(project => (
                                <div key={project.id} className="bg-white p-4 rounded shadow-sm">
                                    <h3 className="text-lg font-medium mb-2">{project.name}</h3>
                                    <p className="text-sm text-gray-600 mb-3">{project.description}</p>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm">
                                            Stage: {project.currentStage}/5
                                        </span>
                                        <div className="flex space-x-2">
                                            <button 
                                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded"
                                                onClick={() => setCurrentProject(project)}
                                            >
                                                Open
                                            </button>
                                            <button 
                                                className="px-3 py-1 bg-red-100 text-red-800 text-sm rounded"
                                                onClick={() => handleDeleteProject(project.id, project.name)}
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function ProjectDetail() {
            const { currentProject, updateProject, deleteProject } = React.useContext(ProjectContext);
            const { addNotification, openModal, setActiveTab } = React.useContext(UIContext);
            const [editMode, setEditMode] = React.useState(false);
            const [name, setName] = React.useState(currentProject?.name || "");
            const [description, setDescription] = React.useState(currentProject?.description || "");
            
            React.useEffect(() => {
                if (currentProject) {
                    setName(currentProject.name);
                    setDescription(currentProject.description);
                }
            }, [currentProject]);
            
            const handleSave = () => {
                if (!name.trim()) {
                    addNotification("Project name is required", "error");
                    return;
                }
                
                updateProject({
                    ...currentProject,
                    name,
                    description
                });
                
                setEditMode(false);
                addNotification("Project updated successfully", "success");
            };
            
            const handleDelete = () => {
                openModal(
                    <div className="p-4">
                        <h3 className="text-lg font-semibold mb-4">Confirm Deletion</h3>
                        <p className="mb-4">Are you sure you want to delete this project? This action cannot be undone.</p>
                        <div className="flex justify-end space-x-2">
                            <button 
                                className="px-4 py-2 bg-gray-200 rounded"
                                onClick={() => openModal(null)}
                            >
                                Cancel
                            </button>
                            <button 
                                className="px-4 py-2 bg-red-600 text-white rounded"
                                onClick={() => {
                                    deleteProject(currentProject.id);
                                    openModal(null);
                                    addNotification("Project deleted", "info");
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                );
            };
            
            const stageCompletionStatus = () => {
                if (!currentProject) return [];
                
                const stageMap = {
                    1: 'caseStudy',
                    2: 'useCase',
                    3: 'specification',
                    4: 'implementation',
                    5: 'verification'
                };
                
                return [1, 2, 3, 4, 5].map(stageNum => {
                    const deliverable = currentProject.deliverables[stageMap[stageNum]];
                    return {
                        stage: stageNum,
                        name: ["Case Study", "Use Case", "Specification", "Implementation", "Verification"][stageNum - 1],
                        status: deliverable ? deliverable.status : 'not_started',
                        completed: deliverable?.status === 'completed'
                    };
                });
            };
            
            if (!currentProject) return <div>No project selected</div>;
            
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold">Project Details</h2>
                        <div className="flex space-x-2">
                            {editMode ? (
                                <>
                                    <button 
                                        className="px-4 py-2 bg-green-600 text-white rounded"
                                        onClick={handleSave}
                                    >
                                        Save
                                    </button>
                                    <button 
                                        className="px-4 py-2 bg-gray-200 rounded"
                                        onClick={() => setEditMode(false)}
                                    >
                                        Cancel
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button 
                                        className="px-4 py-2 bg-blue-600 text-white rounded"
                                        onClick={() => setEditMode(true)}
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        className="px-4 py-2 bg-red-100 text-red-800 rounded"
                                        onClick={handleDelete}
                                    >
                                        Delete
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow-sm mb-6">
                        {editMode ? (
                            <div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">Project Name</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">Description</label>
                                    <textarea 
                                        className="w-full p-2 border rounded"
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        rows="4"
                                    ></textarea>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <h3 className="text-lg font-medium mb-2">{currentProject.name}</h3>
                                <p className="text-gray-700 mb-4">{currentProject.description}</p>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span className="font-medium">Created:</span> {getFormattedDate(currentProject.createdAt)}
                                    </div>
                                    <div>
                                        <span className="font-medium">Last Updated:</span> {getFormattedDate(currentProject.updatedAt)}
                                    </div>
                                    <div>
                                        <span className="font-medium">Current Stage:</span> {currentProject.currentStage}/5
                                    </div>
                                    <div>
                                        <span className="font-medium">Context Files:</span> {currentProject.contextFiles.length}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-6">
                        <h3 className="text-lg font-semibold mb-3">Progress Overview</h3>
                        <div className="bg-white p-4 rounded shadow-sm">
                            <div className="mb-4">
                                <div className="w-full bg-gray-200 rounded-full h-4">
                                    <div 
                                        className="bg-blue-600 h-4 rounded-full"
                                        style={{ width: `${(currentProject.currentStage - 1) * 20}%` }}
                                    ></div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {stageCompletionStatus().map(stage => (
                                    <div 
                                        key={stage.stage}
                                        className={`p-3 rounded border ${stage.completed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}
                                        onClick={() => {
                                            if (stage.stage <= currentProject.currentStage) {
                                                setActiveTab('stage');
                                            }
                                        }}
                                        style={{ cursor: stage.stage <= currentProject.currentStage ? 'pointer' : 'default' }}
                                    >
                                        <div className="flex items-center justify-between">
                                            <span className="font-medium">{stage.name}</span>
                                            <span className={`px-2 py-1 text-xs rounded ${stage.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}`}>
                                                {stage.completed ? 'Completed' : stage.stage === currentProject.currentStage ? 'In Progress' : 'Pending'}
                                            </span>
                                        </div>
                                        {stage.stage === currentProject.currentStage && (
                                            <button 
                                                className="mt-2 w-full px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    setActiveTab('stage');
                                                }}
                                            >
                                                Continue Work
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 className="text-lg font-semibold mb-3">Quick Actions</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button 
                                className="p-4 bg-blue-50 border border-blue-200 rounded text-left hover:bg-blue-100"
                                onClick={() => setActiveTab('stage')}
                            >
                                <span className="block font-medium text-blue-800 mb-1">Continue Current Stage</span>
                                <span className="text-sm text-gray-600">Resume work on current process stage</span>
                            </button>
                            <button 
                                className="p-4 bg-purple-50 border border-purple-200 rounded text-left hover:bg-purple-100"
                                onClick={() => setActiveTab('context')}
                            >
                                <span className="block font-medium text-purple-800 mb-1">Manage Context Files</span>
                                <span className="text-sm text-gray-600">Upload and manage Prime Framework files</span>
                            </button>
                            <button 
                                className="p-4 bg-gray-50 border border-gray-200 rounded text-left hover:bg-gray-100"
                                onClick={() => setActiveTab('settings')}
                            >
                                <span className="block font-medium text-gray-800 mb-1">Settings</span>
                                <span className="text-sm text-gray-600">Configure API keys and application settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function StagePanel() {
            const { currentProject, saveDeliverable, completeStage } = React.useContext(ProjectContext);
            const { currentStage, setCurrentStage, addNotification } = React.useContext(UIContext);
            const { authStatus } = React.useContext(AuthContext);
            const { processContextFile, getRelevantContext, relevantContexts } = React.useContext(RAGContext);
            
            const [deliverableTitle, setDeliverableTitle] = React.useState("");
            const [deliverableContent, setDeliverableContent] = React.useState("");
            const [deliverableFormat, setDeliverableFormat] = React.useState("markdown");
            const [prompt, setPrompt] = React.useState("");
            const [messages, setMessages] = React.useState([]);
            const [isGenerating, setIsGenerating] = React.useState(false);
            
            const stageMap = {
                1: 'caseStudy',
                2: 'useCase',
                3: 'specification',
                4: 'implementation',
                5: 'verification'
            };
            
            const stageInfo = [
                { 
                    title: "Case Study Definition", 
                    description: "Define the domain, research questions, and relevant background information.",
                    inputs: ["Domain/topic description", "Research questions", "Background information", "Existing solutions"],
                    outputs: ["Case study document", "AI-assisted analysis"],
                    promptTemplate: "I'm working on a case study about [DOMAIN]. My research questions are [QUESTIONS]. The background of this problem includes [BACKGROUND]. Can you help me analyze this case study and identify key aspects to focus on?"
                },
                { 
                    title: "Use Case Definition", 
                    description: "Define specific use cases for the Prime Framework in the context of your case study.",
                    inputs: ["Case study reference", "Prime Framework application areas", "Target users/systems", "Expected benefits"],
                    outputs: ["Use case document", "Prime Framework application mapping"],
                    promptTemplate: "Based on my case study about [CASE_STUDY], I need to define use cases for applying the Prime Framework. The target users/systems are [USERS]. The expected benefits are [BENEFITS]. Can you help me identify optimal applications of the Prime Framework for this scenario?"
                },
                { 
                    title: "Specification Development", 
                    description: "Develop detailed technical specifications based on your use case.",
                    inputs: ["Case study and use case references", "Technical requirements", "Constraints and limitations", "Prime Framework components"],
                    outputs: ["Technical specification document", "API/interface definitions", "Component architecture"],
                    promptTemplate: "I need to develop technical specifications for implementing a solution using the Prime Framework. My use case is [USE_CASE]. The technical requirements include [REQUIREMENTS]. Constraints include [CONSTRAINTS]. Which Prime Framework components should I utilize, and how should I structure the specifications?"
                },
                { 
                    title: "Implementation", 
                    description: "Implement your solution based on the specifications using Prime Framework.",
                    inputs: ["All previous deliverables", "Prime Framework Coq proofs", "Implementation language preferences"],
                    outputs: ["Implementation code", "Documentation", "Build/execution instructions"],
                    promptTemplate: "I'm implementing a solution based on my specifications: [SPECIFICATIONS]. I'm using the Prime Framework as the mathematical foundation. Can you help me generate code in [LANGUAGE] that adheres to these specifications and the Prime Framework principles?"
                },
                { 
                    title: "Verification", 
                    description: "Verify that your implementation meets the specifications and requirements.",
                    inputs: ["Implementation code", "Specification requirements", "Test cases", "Expected outputs"],
                    outputs: ["Verification report", "Test results", "Performance metrics"],
                    promptTemplate: "I need to verify my implementation against my specifications. The implementation is [IMPLEMENTATION]. The key requirements to verify are [REQUIREMENTS]. Can you help me develop a verification approach and analyze if the implementation meets these requirements?"
                }
            ];
            
            React.useEffect(() => {
                if (currentProject) {
                    const stageKey = stageMap[currentStage];
                    const deliverable = currentProject.deliverables[stageKey];
                    
                    if (deliverable) {
                        setDeliverableTitle(deliverable.title);
                        setDeliverableContent(deliverable.content);
                        setDeliverableFormat(deliverable.format);
                        
                        if (deliverable.aiPromptHistory) {
                            setMessages(deliverable.aiPromptHistory);
                        } else {
                            setMessages([]);
                        }
                    } else {
                        setDeliverableTitle("");
                        setDeliverableContent("");
                        setDeliverableFormat("markdown");
                        setMessages([]);
                    }
                }
            }, [currentProject, currentStage]);
            
            const handleSaveDeliverable = () => {
                if (!deliverableTitle.trim()) {
                    addNotification("Deliverable title is required", "error");
                    return;
                }
                
                if (!currentProject) return;
                
                const newDeliverable = {
                    id: generateId(),
                    title: deliverableTitle,
                    content: deliverableContent,
                    format: deliverableFormat,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    status: "draft",
                    aiAssisted: messages.length > 0,
                    aiPromptHistory: messages
                };
                
                saveDeliverable(currentProject.id, currentStage, newDeliverable);
                addNotification("Deliverable saved successfully", "success");
            };
            
            const handleCompleteStage = () => {
                if (!deliverableTitle.trim() || !deliverableContent.trim()) {
                    addNotification("Both title and content are required to complete this stage", "error");
                    return;
                }
                
                if (!currentProject) return;
                
                // First save the deliverable if changes were made
                const stageKey = stageMap[currentStage];
                const currentDeliverable = currentProject.deliverables[stageKey];
                
                if (!currentDeliverable || 
                    currentDeliverable.title !== deliverableTitle || 
                    currentDeliverable.content !== deliverableContent || 
                    currentDeliverable.format !== deliverableFormat) {
                    handleSaveDeliverable();
                }
                
                completeStage(currentProject.id, currentStage);
                
                const nextStage = Math.min(5, currentStage + 1);
                setCurrentStage(nextStage);
                
                addNotification(`Stage ${currentStage} completed! Moving to stage ${nextStage}`, "success");
            };
            
            const handleUseContextPrompt = async () => {
                if (!prompt.trim()) {
                    addNotification("Please enter a prompt first", "error");
                    return;
                }
                
                if (authStatus.claude !== 'connected') {
                    addNotification("Claude API connection is required. Please check your settings.", "error");
                    return;
                }
                
                setIsGenerating(true);
                
                // First, get relevant context based on the prompt
                try {
                    await getRelevantContext(prompt);
                    
                    // Simulate Claude API response with context
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const contextStr = relevantContexts.length > 0 
                        ? "\n\nRelevant context from Prime Framework:\n" + 
                          relevantContexts.map(ctx => `[${ctx.filename}]: ${ctx.chunk.text.substring(0, 100)}...`).join("\n\n")
                        : "";
                    
                    const simulatedResponse = `Here's my response to your query about the Prime Framework${contextStr}.\n\nBased on your prompt and the available context, I would recommend the following approach for this stage (${stageInfo[currentStage-1].title}):\n\n1. Start by clearly defining the scope and boundaries of your work.\n2. Reference the Prime Framework principles that are most relevant to your specific case.\n3. Make sure to maintain mathematical consistency throughout your approach.\n4. Consider leveraging the analytic techniques demonstrated in the Prime Framework proofs.\n\nWould you like me to elaborate on any particular aspect?`;
                    
                    const newMessage = {
                        id: generateId(),
                        timestamp: new Date(),
                        prompt: prompt,
                        response: simulatedResponse,
                        modelVersion: "claude-3-opus-20240229",
                        temperature: 0.7,
                        maxTokens: 1000,
                        contextIds: relevantContexts.map(ctx => ctx.fileId)
                    };
                    
                    const updatedMessages = [...messages, newMessage];
                    setMessages(updatedMessages);
                    setPrompt("");
                    
                    // Update deliverable with context from response if it's empty
                    if (!deliverableContent.trim()) {
                        setDeliverableContent(simulatedResponse);
                    }
                } catch (error) {
                    console.error('Error generating response:', error);
                    addNotification("Failed to generate response. Please try again.", "error");
                } finally {
                    setIsGenerating(false);
                }
            };
            
            const handleUseTemplate = () => {
                setPrompt(stageInfo[currentStage-1].promptTemplate);
            };
            
            if (!currentProject) {
                return (
                    <div className="p-6 bg-gray-50 rounded text-center">
                        <p>No project selected. Please select or create a project first.</p>
                    </div>
                );
            }
            
            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <div className="bg-white p-6 rounded shadow-sm mb-6">
                            <h2 className="text-xl font-semibold mb-2">Stage {currentStage}: {stageInfo[currentStage-1].title}</h2>
                            <p className="text-gray-600 mb-4">{stageInfo[currentStage-1].description}</p>
                            
                            <h3 className="font-medium mb-2">Inputs for this stage:</h3>
                            <ul className="list-disc list-inside mb-4 text-sm">
                                {stageInfo[currentStage-1].inputs.map((input, idx) => (
                                    <li key={idx} className="text-gray-700">{input}</li>
                                ))}
                            </ul>
                            
                            <h3 className="font-medium mb-2">Expected outputs:</h3>
                            <ul className="list-disc list-inside mb-4 text-sm">
                                {stageInfo[currentStage-1].outputs.map((output, idx) => (
                                    <li key={idx} className="text-gray-700">{output}</li>
                                ))}
                            </ul>
                        </div>
                        
                        <div className="bg-white p-6 rounded shadow-sm mb-6">
                            <h3 className="text-lg font-medium mb-4">Claude API Assistant</h3>
                            
                            {authStatus.claude !== 'connected' ? (
                                <div className="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                    <p className="text-yellow-800">Claude API connection not configured. Please check your settings.</p>
                                </div>
                            ) : (
                                <>
                                    <div className="mb-4">
                                        <div className="flex justify-between mb-2">
                                            <label className="block text-sm font-medium">Your Prompt</label>
                                            <button 
                                                className="text-sm text-blue-600"
                                                onClick={handleUseTemplate}
                                            >
                                                Use Template
                                            </button>
                                        </div>
                                        <textarea
                                            className="w-full p-2 border rounded"
                                            rows="4"
                                            value={prompt}
                                            onChange={(e) => setPrompt(e.target.value)}
                                            placeholder="Enter your prompt for Claude..."
                                        ></textarea>
                                    </div>
                                    
                                    <div className="flex justify-between mb-4">
                                        <button 
                                            className="px-4 py-2 bg-purple-600 text-white rounded flex items-center"
                                            onClick={handleUseContextPrompt}
                                            disabled={isGenerating}
                                        >
                                            {isGenerating ? (
                                                <>
                                                    <span className="mr-2">Generating...</span>
                                                    <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                </>
                                            ) : (
                                                "Generate with Context"
                                            )}
                                        </button>
                                        
                                        <button
                                            className="px-4 py-2 bg-gray-200 rounded"
                                            onClick={() => setMessages([])}
                                        >
                                            Clear History
                                        </button>
                                    </div>
                                    
                                    <div className="border rounded max-h-96 overflow-y-auto p-2">
                                        {messages.length === 0 ? (
                                            <p className="text-gray-500 text-center py-4">No messages yet. Start a conversation with Claude.</p>
                                        ) : (
                                            <div className="space-y-4">
                                                {messages.map(message => (
                                                    <div key={message.id} className="space-y-2">
                                                        <div className="bg-blue-50 p-3 rounded">
                                                            <p className="text-sm font-medium text-blue-800">You:</p>
                                                            <p className="text-sm">{message.prompt}</p>
                                                        </div>
                                                        <div className="bg-purple-50 p-3 rounded">
                                                            <p className="text-sm font-medium text-purple-800">Claude:</p>
                                                            <div className="text-sm whitespace-pre-line">{message.response}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    
                    <div>
                        <div className="bg-white p-6 rounded shadow-sm mb-6">
                            <h3 className="text-lg font-medium mb-4">Deliverable Editor</h3>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Title</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded"
                                    value={deliverableTitle}
                                    onChange={(e) => setDeliverableTitle(e.target.value)}
                                    placeholder="Enter deliverable title"
                                />
                            </div>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Format</label>
                                <select 
                                    className="w-full p-2 border rounded"
                                    value={deliverableFormat}
                                    onChange={(e) => setDeliverableFormat(e.target.value)}
                                >
                                    <option value="markdown">Markdown</option>
                                    <option value="code">Code</option>
                                    <option value="json">JSON</option>
                                    <option value="text">Plain Text</option>
                                </select>
                            </div>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Content</label>
                                <textarea 
                                    className="w-full p-2 border rounded font-mono"
                                    rows="12"
                                    value={deliverableContent}
                                    onChange={(e) => setDeliverableContent(e.target.value)}
                                    placeholder="Enter deliverable content..."
                                ></textarea>
                            </div>
                            
                            <div className="flex justify-between">
                                <button 
                                    className="px-4 py-2 bg-blue-600 text-white rounded"
                                    onClick={handleSaveDeliverable}
                                >
                                    Save Draft
                                </button>
                                
                                <button 
                                    className="px-4 py-2 bg-green-600 text-white rounded"
                                    onClick={handleCompleteStage}
                                >
                                    Complete & Proceed
                                </button>
                            </div>
                        </div>
                        
                        {deliverableFormat === 'markdown' && deliverableContent && (
                            <div className="bg-white p-6 rounded shadow-sm">
                                <h3 className="text-lg font-medium mb-4">Preview</h3>
                                <div 
                                    className="prose max-w-none border rounded p-4"
                                    dangerouslySetInnerHTML={{ 
                                        __html: window.markdownit ? window.markdownit().render(deliverableContent) : deliverableContent
                                    }}
                                ></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ContextManager() {
            const { currentProject, addContextFile, updateContextFile, deleteContextFile } = React.useContext(ProjectContext);
            const { addNotification, openModal } = React.useContext(UIContext);
            const { processContextFile, processingQueue } = React.useContext(RAGContext);
            const [fileContent, setFileContent] = React.useState("");
            const [fileName, setFileName] = React.useState("");
            const [fileType, setFileType] = React.useState("coq");
            const [selectedFile, setSelectedFile] = React.useState(null);
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setFileName(file.name);
                
                // Determine file type from extension
                const extension = file.name.split('.').pop().toLowerCase();
                if (extension === 'v' || extension === 'coq') {
                    setFileType('coq');
                } else if (extension === 'md' || extension === 'markdown') {
                    setFileType('markdown');
                } else if (extension === 'json') {
                    setFileType('json');
                } else {
                    setFileType('other');
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    setFileContent(event.target.result);
                };
                reader.readAsText(file);
            };
            
            const handleAddFile = () => {
                if (!fileName.trim() || !fileContent.trim()) {
                    addNotification("Both file name and content are required", "error");
                    return;
                }
                
                if (!currentProject) return;
                
                const newFile = {
                    filename: fileName,
                    content: fileContent,
                    fileType: fileType,
                    processed: false,
                    embeddingStatus: 'not_started'
                };
                
                addContextFile(currentProject.id, newFile);
                addNotification(`File "${fileName}" added successfully`, "success");
                
                // Reset the form
                setFileName("");
                setFileContent("");
                setFileType("coq");
                
                // Reset the file input
                const fileInput = document.getElementById('context-file-input');
                if (fileInput) fileInput.value = "";
            };
            
            const handleProcessFile = async (fileId) => {
                if (!currentProject) return;
                
                const file = currentProject.contextFiles.find(f => f.id === fileId);
                if (!file) return;
                
                try {
                    const success = await processContextFile(fileId);
                    
                    if (success) {
                        const updatedFile = {
                            ...file,
                            processed: true,
                            embeddingStatus: 'completed'
                        };
                        
                        updateContextFile(currentProject.id, updatedFile);
                        addNotification(`File "${file.filename}" processed successfully`, "success");
                    } else {
                        addNotification(`Failed to process file "${file.filename}"`, "error");
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    addNotification(`Error processing file: ${error.message}`, "error");
                }
            };
            
            const handleDeleteFile = (fileId) => {
                if (!currentProject) return;
                
                const file = currentProject.contextFiles.find(f => f.id === fileId);
                if (!file) return;
                
                openModal(
                    <div className="p-4">
                        <h3 className="text-lg font-semibold mb-4">Confirm Deletion</h3>
                        <p className="mb-4">Are you sure you want to delete file "{file.filename}"?</p>
                        <div className="flex justify-end space-x-2">
                            <button 
                                className="px-4 py-2 bg-gray-200 rounded"
                                onClick={() => openModal(null)}
                            >
                                Cancel
                            </button>
                            <button 
                                className="px-4 py-2 bg-red-600 text-white rounded"
                                onClick={() => {
                                    deleteContextFile(currentProject.id, fileId);
                                    openModal(null);
                                    addNotification(`File "${file.filename}" deleted`, "info");
                                }}
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                );
            };
            
            const handleViewFile = (file) => {
                setSelectedFile(file);
            };
            
            if (!currentProject) {
                return (
                    <div className="p-6 bg-gray-50 rounded text-center">
                        <p>No project selected. Please select or create a project first.</p>
                    </div>
                );
            }
            
            return (
                <div>
                    <h2 className="text-xl font-semibold mb-6">Context Manager</h2>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div className="bg-white p-6 rounded shadow-sm mb-6">
                                <h3 className="text-lg font-medium mb-4">Upload Context File</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">File</label>
                                    <input 
                                        id="context-file-input"
                                        type="file" 
                                        className="w-full p-2 border rounded"
                                        onChange={handleFileChange}
                                        accept=".v,.coq,.md,.markdown,.json,.txt"
                                    />
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">File Name</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded"
                                        value={fileName}
                                        onChange={(e) => setFileName(e.target.value)}
                                        placeholder="Enter file name"
                                    />
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">File Type</label>
                                    <select 
                                        className="w-full p-2 border rounded"
                                        value={fileType}
                                        onChange={(e) => setFileType(e.target.value)}
                                    >
                                        <option value="coq">Coq Proof</option>
                                        <option value="markdown">Markdown</option>
                                        <option value="json">JSON</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">Content Preview</label>
                                    <textarea 
                                        className="w-full p-2 border rounded font-mono text-sm"
                                        rows="8"
                                        value={fileContent}
                                        onChange={(e) => setFileContent(e.target.value)}
                                        placeholder="File content will appear here..."
                                    ></textarea>
                                </div>
                                
                                <button 
                                    className="px-4 py-2 bg-blue-600 text-white rounded"
                                    onClick={handleAddFile}
                                    disabled={!fileName.trim() || !fileContent.trim()}
                                >
                                    Add Context File
                                </button>
                            </div>
                            
                            {selectedFile && (
                                <div className="bg-white p-6 rounded shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-medium">File Details: {selectedFile.filename}</h3>
                                        <button 
                                            className="text-gray-500"
                                            onClick={() => setSelectedFile(null)}
                                        >
                                            Close
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2 text-sm mb-4">
                                        <div>
                                            <span className="font-medium">Type:</span> {selectedFile.fileType}
                                        </div>
                                        <div>
                                            <span className="font-medium">Processed:</span> {selectedFile.processed ? 'Yes' : 'No'}
                                        </div>
                                        <div>
                                            <span className="font-medium">Embedding Status:</span> {selectedFile.embeddingStatus}
                                        </div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium mb-1">Content</label>
                                        <pre className="whitespace-pre-wrap border rounded p-3 bg-gray-50 font-mono text-sm max-h-96 overflow-y-auto">
                                            {selectedFile.content}
                                        </pre>
                                    </div>
                                    
                                    {!selectedFile.processed && (
                                        <button 
                                            className="px-4 py-2 bg-green-600 text-white rounded mr-2"
                                            onClick={() => handleProcessFile(selectedFile.id)}
                                            disabled={processingQueue.includes(selectedFile.id)}
                                        >
                                            {processingQueue.includes(selectedFile.id) ? 'Processing...' : 'Process File'}
                                        </button>
                                    )}
                                    
                                    <button 
                                        className="px-4 py-2 bg-red-100 text-red-800 rounded"
                                        onClick={() => handleDeleteFile(selectedFile.id)}
                                    >
                                        Delete File
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div>
                            <div className="bg-white p-6 rounded shadow-sm">
                                <h3 className="text-lg font-medium mb-4">Context Files</h3>
                                
                                {currentProject.contextFiles.length === 0 ? (
                                    <div className="bg-gray-50 p-6 rounded text-center">
                                        <p className="text-gray-500">No context files found. Upload your first file to get started.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {currentProject.contextFiles.map(file => (
                                            <div 
                                                key={file.id} 
                                                className="border rounded p-3 hover:bg-gray-50"
                                            >
                                                <div className="flex justify-between">
                                                    <div>
                                                        <h4 className="font-medium">{file.filename}</h4>
                                                        <div className="flex text-sm text-gray-500 space-x-4">
                                                            <span>Type: {file.fileType}</span>
                                                            <span>
                                                                Status: 
                                                                {processingQueue.includes(file.id) ? (
                                                                    <span className="text-blue-600"> Processing...</span>
                                                                ) : file.processed ? (
                                                                    <span className="text-green-600"> Processed</span>
                                                                ) : (
                                                                    <span className="text-yellow-600"> Unprocessed</span>
                                                                )}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <button 
                                                            className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm"
                                                            onClick={() => handleViewFile(file)}
                                                        >
                                                            View
                                                        </button>
                                                        
                                                        {!file.processed && !processingQueue.includes(file.id) && (
                                                            <button 
                                                                className="px-2 py-1 bg-green-100 text-green-800 rounded text-sm"
                                                                onClick={() => handleProcessFile(file.id)}
                                                            >
                                                                Process
                                                            </button>
                                                        )}
                                                        
                                                        <button 
                                                            className="px-2 py-1 bg-red-100 text-red-800 rounded text-sm"
                                                            onClick={() => handleDeleteFile(file.id)}
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="mt-6">
                                    <h4 className="font-medium mb-2">Processing Statistics</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-3 rounded border">
                                            <span className="block text-sm font-medium">Total Files</span>
                                            <span className="text-xl">{currentProject.contextFiles.length}</span>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded border">
                                            <span className="block text-sm font-medium">Processed</span>
                                            <span className="text-xl">{currentProject.contextFiles.filter(f => f.processed).length}</span>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded border">
                                            <span className="block text-sm font-medium">Unprocessed</span>
                                            <span className="text-xl">{currentProject.contextFiles.filter(f => !f.processed).length}</span>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded border">
                                            <span className="block text-sm font-medium">In Progress</span>
                                            <span className="text-xl">{processingQueue.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SettingsPanel() {
            const { authConfig, authStatus, updateClaudeApiKey, testClaudeConnection, updateService } = React.useContext(AuthContext);
            const { addNotification } = React.useContext(UIContext);
            const [apiKey, setApiKey] = React.useState(authConfig.claudeApiKey || "");
            const [isTestingConnection, setIsTestingConnection] = React.useState(false);
            const [showApiKey, setShowApiKey] = React.useState(false);
            
            const handleSaveApiKey = () => {
                updateClaudeApiKey(apiKey);
                addNotification("API key saved", "success");
            };
            
            const handleTestConnection = async () => {
                if (!apiKey.trim()) {
                    addNotification("API key is required", "error");
                    return;
                }
                
                setIsTestingConnection(true);
                
                try {
                    const success = await testClaudeConnection();
                    
                    if (success) {
                        addNotification("Connection to Claude API successful", "success");
                    } else {
                        addNotification("Failed to connect to Claude API", "error");
                    }
                } catch (error) {
                    console.error('Connection test error:', error);
                    addNotification(`Connection test error: ${error.message}`, "error");
                } finally {
                    setIsTestingConnection(false);
                }
            };
            
            const getStatusBadge = (status) => {
                switch (status) {
                    case 'connected':
                        return <span className="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">Connected</span>;
                    case 'connecting':
                        return <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">Connecting...</span>;
                    case 'error':
                        return <span className="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">Error</span>;
                    case 'disconnected':
                    default:
                        return <span className="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm">Disconnected</span>;
                }
            };
            
            return (
                <div>
                    <h2 className="text-xl font-semibold mb-6">Settings</h2>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div className="bg-white p-6 rounded shadow-sm mb-6">
                                <h3 className="text-lg font-medium mb-4">Claude API Settings</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">API Key</label>
                                    <div className="flex">
                                        <input 
                                            type={showApiKey ? "text" : "password"} 
                                            className="flex-1 p-2 border rounded-l"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            placeholder="Enter Claude API key"
                                        />
                                        <button 
                                            className="px-3 py-2 bg-gray-200 rounded-r"
                                            onClick={() => setShowApiKey(!showApiKey)}
                                        >
                                            {showApiKey ? "Hide" : "Show"}
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Your API key is encrypted and stored locally in your browser.</p>
                                </div>
                                
                                <div className="flex justify-between items-center">
                                    <div>
                                        <span className="mr-2">Status:</span>
                                        {getStatusBadge(authStatus.claude)}
                                    </div>
                                    
                                    <div className="flex space-x-2">
                                        <button 
                                            className="px-4 py-2 bg-blue-600 text-white rounded"
                                            onClick={handleSaveApiKey}
                                        >
                                            Save
                                        </button>
                                        
                                        <button 
                                            className="px-4 py-2 bg-gray-200 rounded flex items-center"
                                            onClick={handleTestConnection}
                                            disabled={isTestingConnection}
                                        >
                                            {isTestingConnection ? (
                                                <>
                                                    <span className="mr-2">Testing...</span>
                                                    <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                </>
                                            ) : (
                                                "Test Connection"
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-white p-6 rounded shadow-sm">
                                <h3 className="text-lg font-medium mb-4">Application Settings</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">Theme</label>
                                    <select className="w-full p-2 border rounded">
                                        <option value="light">Light</option>
                                        <option value="dark">Dark</option>
                                        <option value="system">System</option>
                                    </select>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">Default Deliverable Format</label>
                                    <select className="w-full p-2 border rounded">
                                        <option value="markdown">Markdown</option>
                                        <option value="code">Code</option>
                                        <option value="json">JSON</option>
                                        <option value="text">Plain Text</option>
                                    </select>
                                </div>
                                
                                <div className="mb-4">
                                    <div className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            id="auto-save" 
                                            className="mr-2"
                                        />
                                        <label htmlFor="auto-save" className="text-sm font-medium">Enable Auto-Save</label>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Automatically save deliverables every 5 minutes.</p>
                                </div>
                                
                                <button className="px-4 py-2 bg-blue-600 text-white rounded">
                                    Save Settings
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <div className="bg-white p-6 rounded shadow-sm mb-6">
                                <h3 className="text-lg font-medium mb-4">Data Management</h3>
                                
                                <div className="mb-6">
                                    <h4 className="text-md font-medium mb-2">Export/Import</h4>
                                    
                                    <div className="flex space-x-2 mb-4">
                                        <button className="px-4 py-2 bg-gray-200 rounded flex-1">
                                            Export All Projects
                                        </button>
                                        
                                        <button className="px-4 py-2 bg-gray-200 rounded flex-1">
                                            Import Projects
                                        </button>
                                    </div>
                                    
                                    <p className="text-xs text-gray-500">
                                        Export creates a JSON file with all your projects and settings. 
                                        Import allows you to restore from a previously exported file.
                                    </p>
                                </div>
                                
                                <div>
                                    <h4 className="text-md font-medium mb-2">Clear Data</h4>
                                    
                                    <div className="space-y-2">
                                        <button className="w-full px-4 py-2 bg-yellow-100 text-yellow-800 rounded text-left">
                                            Clear All Settings
                                        </button>
                                        
                                        <button className="w-full px-4 py-2 bg-red-100 text-red-800 rounded text-left">
                                            Clear All Projects
                                        </button>
                                        
                                        <button className="w-full px-4 py-2 bg-red-600 text-white rounded text-left">
                                            Reset Everything
                                        </button>
                                    </div>
                                    
                                    <p className="text-xs text-gray-500 mt-2">
                                        Warning: Clearing data cannot be undone. Export your data before clearing if you want to keep a backup.
                                    </p>
                                </div>
                            </div>
                            
                            <div className="bg-white p-6 rounded shadow-sm">
                                <h3 className="text-lg font-medium mb-4">About</h3>
                                
                                <div className="mb-4">
                                    <h4 className="text-md font-medium">Prime Framework Research Dashboard</h4>
                                    <p className="text-sm text-gray-600">Version 1.0.0</p>
                                </div>
                                
                                <p className="text-sm text-gray-700 mb-4">
                                    This application formalizes and facilitates the process of Prime Framework-based research and development.
                                    It guides users through a structured workflow from case study selection to verification, leveraging the
                                    mathematical foundations of the Prime Framework combined with AI assistance.
                                </p>
                                
                                <div className="p-3 bg-gray-50 rounded border text-sm">
                                    <p>Developed by: UOR Foundation</p>
                                    <p>Website: <a href="https://uor.foundation" target="_blank" className="text-blue-600 hover:underline">uor.foundation</a></p>
                                    <p>Join our community: <a href="https://discord.gg/ZwuZaNyuve" target="_blank" className="text-blue-600 hover:underline">Discord</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function NotificationArea() {
            const { notifications, removeNotification } = React.useContext(UIContext);
            
            const getNotificationClass = (type) => {
                switch (type) {
                    case 'success':
                        return 'bg-green-50 border-green-200 text-green-800';
                    case 'error':
                        return 'bg-red-50 border-red-200 text-red-800';
                    case 'warning':
                        return 'bg-yellow-50 border-yellow-200 text-yellow-800';
                    case 'info':
                    default:
                        return 'bg-blue-50 border-blue-200 text-blue-800';
                }
            };
            
            if (notifications.length === 0) return null;
            
            return (
                <div className="fixed bottom-4 right-4 space-y-2 z-50">
                    {notifications.map(notification => (
                        <div 
                            key={notification.id} 
                            className={`p-3 rounded shadow-md border ${getNotificationClass(notification.type)} flex justify-between items-center`}
                            style={{ minWidth: '300px', maxWidth: '400px' }}
                        >
                            <span>{notification.message}</span>
                            <button 
                                className="ml-2 text-gray-500 hover:text-gray-700"
                                onClick={() => removeNotification(notification.id)}
                            >
                                &times;
                            </button>
                        </div>
                    ))}
                </div>
            );
        }

        function ModalContainer() {
            const { modalContent, closeModal } = React.useContext(UIContext);
            
            if (!modalContent) return null;
            
            return (
                <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                    <div className="bg-white rounded shadow-lg max-w-md w-full">
                        {modalContent}
                    </div>
                </div>
            );
        }

        function Footer() {
            return (
                <footer className="bg-gray-100 p-4 border-t">
                    <div className="flex justify-between items-center">
                        <p className="text-sm text-gray-600">Prime Framework Research Dashboard &copy; 2025 <a href="https://uor.foundation" target="_blank" className="text-blue-600 hover:underline">UOR Foundation</a></p>
                        <div className="text-sm text-gray-500 flex items-center">
                            <span className="mr-4">Version 1.0.0</span>
                            <a href="https://discord.gg/ZwuZaNyuve" target="_blank" className="text-blue-600 hover:underline">Join Discord</a>
                        </div>
                    </div>
                </footer>
            );
        }

        // Initialize the application
        (function() {
            console.log("DOM loaded, starting initialization");
            console.log("React available:", typeof React !== 'undefined');
            console.log("ReactDOM available:", typeof ReactDOM !== 'undefined');
            
            // Make sure markdownit is available globally
            window.markdownit = window.markdownit || (typeof markdownit !== 'undefined' ? markdownit : null);
            console.log("markdownit available:", window.markdownit !== null);
            
            // Wait a bit to ensure all scripts are loaded
            setTimeout(function() {
                try {
                    console.log("Initializing React app...");
                    const rootElement = document.getElementById('root');
                    console.log("Root element found:", rootElement !== null);
                    
                    if (typeof React === 'undefined') {
                        throw new Error("React is not defined. Check script loading.");
                    }
                    
                    if (typeof ReactDOM === 'undefined') {
                        throw new Error("ReactDOM is not defined. Check script loading.");
                    }
                    
                    // Skip test component rendering - no longer needed for debugging
                    
                    // Now try rendering the real app using React 18's createRoot
                    console.log("Rendering main app with createRoot...");
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(React.createElement(App, null));
                    console.log("Main app rendered successfully");
                } catch (error) {
                    console.error("Error rendering React app:", error);
                    document.getElementById('root').innerHTML = `
                        <div style="color: red; padding: 20px;">
                            <h2>Error Initializing Application</h2>
                            <p>${error.message}</p>
                            <pre>${error.stack}</pre>
                        </div>
                    `;
                }
            }, 500);
        })();
    </script>
</body>
</html>
